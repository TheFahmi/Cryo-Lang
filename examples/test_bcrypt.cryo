// ============================================
// CRYO BCRYPT LIBRARY TEST
// ============================================

import "bcrypt"

fn main() {
    print("========================================");
    print("   CRYO BCRYPT LIBRARY TEST");
    print("========================================");
    print("");
    
    let passed = 0;
    let failed = 0;
    
    // Test 1: Generate salt
    print("[TEST 1] Generate Salt");
    let salt = bcryptGenerateSalt(10);
    
    if (startsWith(salt, "$2b$") && len(salt) > 7) {
        print("  ✓ PASS: Salt generated");
        print("  Salt: " + salt);
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Salt generation failed");
        failed = failed + 1;
    }
    
    // Test 2: Hash password
    print("");
    print("[TEST 2] Hash Password");
    let result = hashPassword("mypassword123", 10);
    
    if (result["success"] && startsWith(result["hash"], "$2b$")) {
        print("  ✓ PASS: Password hashed");
        print("  Hash: " + substring(result["hash"], 0, 40) + "...");
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: " + result["error"]);
        failed = failed + 1;
    }
    
    // Test 3: Verify correct password
    print("");
    print("[TEST 3] Verify Correct Password");
    let hash = result["hash"];
    let verified = bcryptVerify("mypassword123", hash);
    
    if (verified) {
        print("  ✓ PASS: Correct password verified");
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Verification failed");
        failed = failed + 1;
    }
    
    // Test 4: Reject wrong password
    print("");
    print("[TEST 4] Reject Wrong Password");
    let wrongVerified = bcryptVerify("wrongpassword", hash);
    
    if (!wrongVerified) {
        print("  ✓ PASS: Wrong password rejected");
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Wrong password was accepted");
        failed = failed + 1;
    }
    
    // Test 5: Password strength check
    print("");
    print("[TEST 5] Password Strength Check");
    let strength = checkPasswordStrength("MyP@ssw0rd!");
    
    if (strength.score >= 3 && strength.hasUpper && strength.hasLower && strength.hasDigit && strength.hasSpecial) {
        print("  ✓ PASS: Strong password detected");
        print("  Score: " + strength.score + "/4 - " + strength.feedback);
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Strength check incorrect");
        failed = failed + 1;
    }
    
    // Test 6: Weak password detection
    print("");
    print("[TEST 6] Weak Password Detection");
    let weakStrength = checkPasswordStrength("abc");
    
    if (weakStrength.score <= 1) {
        print("  ✓ PASS: Weak password identified");
        print("  Score: " + weakStrength.score + "/4 - " + weakStrength.feedback);
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Weak password not detected");
        failed = failed + 1;
    }
    
    // Summary
    print("");
    print("========================================");
    print("   TEST SUMMARY");
    print("========================================");
    print("  Passed: " + passed);
    print("  Failed: " + failed);
    print("  Total:  " + (passed + failed));
    print("");
    
    if (failed == 0) {
        print("  ✓ ALL TESTS PASSED!");
        return 0;
    } else {
        print("  ✗ SOME TESTS FAILED");
        return 1;
    }
}
