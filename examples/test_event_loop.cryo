// Test Event Loop Library
import "event_loop"

fn main() {
    print("========================================");
    print("   CRYO EVENT LOOP LIBRARY TEST");
    print("========================================");
    
    let passed = 0;
    let failed = 0;
    
    // Test 1: Reset and Initial State
    print("");
    print("[TEST 1] Initial State");
    reset();
    
    if (isRunning() == false && getTickCount() == 0) {
        print("  ✓ PASS: Initial state correct");
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Initial state wrong");
        failed = failed + 1;
    }
    
    // Test 2: Set Immediate
    print("");
    print("[TEST 2] Set Immediate");
    let immId = setImmediate("testCallback", "arg1");
    
    if (immId >= 0) {
        print("  ✓ PASS: Immediate scheduled, id=" + immId);
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: setImmediate failed");
        failed = failed + 1;
    }
    
    // Test 3: Set Timeout
    print("");
    print("[TEST 3] Set Timeout");
    let timerId = setTimeout("onTimeout", 1000, null);
    
    if (timerId > 0) {
        print("  ✓ PASS: Timeout scheduled, id=" + timerId);
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: setTimeout failed");
        failed = failed + 1;
    }
    
    // Test 4: Set Interval
    print("");
    print("[TEST 4] Set Interval");
    let intervalId = setInterval("onInterval", 500, null);
    
    if (intervalId > 0) {
        print("  ✓ PASS: Interval scheduled, id=" + intervalId);
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: setInterval failed");
        failed = failed + 1;
    }
    
    // Test 5: Pending Timers
    print("");
    print("[TEST 5] Pending Timers");
    let pending = pendingTimers();
    
    if (pending == 2) {
        print("  ✓ PASS: " + pending + " timers pending");
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Expected 2 timers, got " + pending);
        failed = failed + 1;
    }
    
    // Test 6: Emit Event
    print("");
    print("[TEST 6] Emit Event");
    emit("testEvent", "payload");
    emit("anotherEvent", 123);
    
    let eventCount = pendingEvents();
    if (eventCount == 2) {
        print("  ✓ PASS: " + eventCount + " events pending");
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Expected 2 events, got " + eventCount);
        failed = failed + 1;
    }
    
    // Test 7: Run Single Tick
    print("");
    print("[TEST 7] Run Single Tick");
    let processed = tick();
    
    if (processed > 0) {
        print("  ✓ PASS: Processed " + processed + " items");
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Nothing processed");
        failed = failed + 1;
    }
    
    // Test 8: Clear Timeout
    print("");
    print("[TEST 8] Clear Timeout");
    reset();
    let t1 = setTimeout("cb1", 100, null);
    let t2 = setTimeout("cb2", 200, null);
    clearTimeout(t1);
    
    let remaining = pendingTimers();
    if (remaining == 1) {
        print("  ✓ PASS: Timer cleared, " + remaining + " remaining");
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Expected 1 timer, got " + remaining);
        failed = failed + 1;
    }
    
    // Test 9: Next Tick
    print("");
    print("[TEST 9] Next Tick");
    reset();
    nextTick("highPriority", null);
    setImmediate("lowPriority", null);
    
    tick();
    let tickNum = getTickCount();
    if (tickNum == 1) {
        print("  ✓ PASS: Tick executed");
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Tick count wrong");
        failed = failed + 1;
    }
    
    // Test 10: Run to Completion
    print("");
    print("[TEST 10] Run to Completion");
    reset();
    emit("e1", null);
    emit("e2", null);
    emit("e3", null);
    setMaxTicks(100);
    
    let totalTicks = run();
    if (isRunning() == false && totalTicks > 0) {
        print("  ✓ PASS: Ran " + totalTicks + " ticks");
        passed = passed + 1;
    } else {
        print("  ✗ FAIL: Run failed");
        failed = failed + 1;
    }
    
    // Summary
    print("");
    print("========================================");
    print("   TEST SUMMARY");
    print("========================================");
    print("  Passed: " + passed);
    print("  Failed: " + failed);
    print("  Total:  " + (passed + failed));
    print("");
    
    if (failed == 0) {
        print("  ✓ ALL TESTS PASSED!");
    } else {
        print("  ✗ SOME TESTS FAILED");
    }
    
    return 0;
}
